<div id="search-container">
  <!-- Search Input styled as button -->
  <input type="text" id="search-input-box" autocomplete="off" placeholder="Search..." />

  <!-- Search Modal -->
  <div id="search-modal" style="display:none;">
    <div id="modal-content">
      <span id="close-modal">&times;</span>
      <input type="text" id="search-input" placeholder="Search..." />
      <button id="search-submit">Search</button>
      
      <!-- Search results container -->
      <div id="search-results" tabindex="0"></div>
    </div>
  </div>
</div>

<!-- Modal and Search Styling -->
<style>
  /* Style for search input box (replaces button) */
  #search-input-box {
    padding: 8px 16px;
    font-size: 16px;
    cursor: pointer;
    border: 1px solid #eaecef;
    border-radius: 6px;
    width: 100%;
    box-sizing: border-box;
    margin-bottom: 20px;
  }

  /* Modal background */
  #search-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Modal content */
  #modal-content {
    background: white;
    padding: 20px;
    width: 60%;
    max-width: 600px;
    position: relative;
    border-radius: 6px;
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  }

  /* Close button */
  #close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
  }

  /* Search results */
  #search-results {
    margin-top: 20px;
    max-height: 300px;
    overflow-y: auto;
    border-top: 1px solid #eaecef;
    padding-top: 10px;
  }

  .search-result {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eaecef;
  }

  .search-result-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: #0366d6;
    text-decoration: none;
  }

  .search-result-title:hover {
    text-decoration: underline;
  }

  .search-result-context {
    font-size: 14px;
    color: #586069;
  }

  /* Highlighted search result */
  .highlight {
    background-color: #eaecef;
  }
</style>

<!-- FlexSearch CDN -->
<script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>

<!-- JavaScript for modal and search -->
<script>
  let currentSelectionIndex = -1;

  // Open and close modal
  const searchInputBox = document.getElementById('search-input-box');
  const searchModal = document.getElementById('search-modal');
  const closeModal = document.getElementById('close-modal');
  const searchResults = document.getElementById('search-results');
  let searchResultsArray = [];

  // Open modal when search input is clicked or when pressing Command + K
  searchInputBox.addEventListener('click', function() {
    searchModal.style.display = 'flex';
  });

  document.addEventListener('keydown', function(event) {
    if (event.metaKey && event.key === 'k') {
      event.preventDefault();
      searchModal.style.display = 'flex';
      document.getElementById('search-input').focus();
    }
  });

  // Close modal when close button is clicked
  closeModal.addEventListener('click', function() {
    searchModal.style.display = 'none';
  });

  // Close modal when clicking outside of modal content
  window.addEventListener('click', function(event) {
    if (event.target == searchModal) {
      searchModal.style.display = 'none';
    }
  });

  // Handle keyboard navigation (arrow keys and enter)
  document.addEventListener('keydown', function(event) {
    if (searchModal.style.display === 'flex' && searchResultsArray.length > 0) {
      if (event.key === 'ArrowDown') {
        event.preventDefault();
        selectNextResult();
      } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        selectPreviousResult();
      } else if (event.key === 'Enter' && currentSelectionIndex >= 0) {
        event.preventDefault();
        navigateToSelectedResult();
      }
    }
  });

  function selectNextResult() {
    if (currentSelectionIndex < searchResultsArray.length - 1) {
      currentSelectionIndex++;
      updateSelectedResult();
    }
  }

  function selectPreviousResult() {
    if (currentSelectionIndex > 0) {
      currentSelectionIndex--;
      updateSelectedResult();
    }
  }

  function updateSelectedResult() {
    searchResultsArray.forEach((result, index) => {
      if (index === currentSelectionIndex) {
        result.classList.add('highlight');
        result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        result.classList.remove('highlight');
      }
    });
  }

  function navigateToSelectedResult() {
    const selectedResult = searchResultsArray[currentSelectionIndex];
    const link = selectedResult.querySelector('a');
    if (link) {
      link.click();
    }
  }

  // Execute search when pressing "Enter" in the input field
  const searchInput = document.getElementById('search-input');
  searchInput.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
      event.preventDefault();
      searchSubmit.click();
      searchResults.focus();  // Focus on search results after Enter is pressed
    }
  });

  // Perform search when search button is clicked
  const searchSubmit = document.getElementById('search-submit');
  
  searchSubmit.addEventListener('click', async function() {
    const query = document.getElementById('search-input').value.trim().toLowerCase();
    searchResults.innerHTML = '';
    currentSelectionIndex = -1;

    if (query.length === 0) {
      searchResults.innerHTML = '<p>Please enter a search term.</p>';
      return;
    }

    // Load the JSON search index file
    console.log('Loading search index from:', '/searchIndex.json');
    const response = await fetch('/searchIndex.json');
    const indexData = await response.json();

    const index = new FlexSearch.Document({
      document: {
        id: 'id',
        index: ['content'],
        store: ['title', 'url', 'content']
      }
    });

    // Import the index
    for (const [key, data] of Object.entries(indexData)) {
      await index.import(key, data);
    }

    // Perform search
    const results = await index.search({
      query,
      field: 'content'
    });

    if (results.length > 0) {
      searchResultsArray = [];
      results.forEach(result => {
        result.result.forEach(docId => {
          const doc = index.store[docId];
          if (doc && doc.content) {
            const searchTermIndex = doc.content.toLowerCase().indexOf(query);
            const contextBefore = doc.content.substring(Math.max(0, searchTermIndex - 30), searchTermIndex);
            const contextAfter = doc.content.substring(searchTermIndex + query.length, Math.min(doc.content.length, searchTermIndex + query.length + 30));
            const searchResultHtml = `
              <div class="search-result">
                <a href="${doc.url}" class="search-result-title" onclick="scrollToTOC('${doc.url}')">${doc.title}</a>
                <div class="search-result-context">...${contextBefore}<strong>${query}</strong>${contextAfter}...</div>
              </div>
            `;
            const resultElement = document.createElement('div');
            resultElement.innerHTML = searchResultHtml;
            searchResults.appendChild(resultElement);
            searchResultsArray.push(resultElement);

            // Automatically select the first result
            if (searchResultsArray.length === 1) {
              currentSelectionIndex = 0;
              updateSelectedResult();
            }
          }
        });
      });
    } else {
      searchResults.innerHTML = '<p>No results found.</p>';
    }
  });

  // Trigger the TOC link click to use TocBot's smooth scrolling behavior
  function scrollToTOC(url) {
    const elementId = url.split('#')[1];
    const tocLink = document.querySelector(`.toc-sidebar a[href="#${elementId}"]`);

    if (tocLink) {
      tocLink.click(); // Simulate a click on the TOC link for smooth scroll
      closeModalAfterClick();
    }
  }

  // Close modal after clicking a search result
  function closeModalAfterClick() {
    searchModal.style.display = 'none';
  }
</script>

