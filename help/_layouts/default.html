<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.27.4/tocbot.css">
    <style>
        body {
            margin: 0;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", sans-serif;
            background-color: #f9fafb;
            color: #333;
        }

        /* Header styling */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff;
            padding: 15px 0px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #0366d6;
            margin-left: 20px;
        }

        .logo a {
            text-decoration: none;
            color: inherit;
        }

        /* Dropdown styling */
        .dropdown {
            position: relative;
            display: inline-block;
            font-size: 24px; /* Match the logo font size */
            font-weight: normal;
            text-decoration: underline;
            color: #0366d6;
            cursor: pointer;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            padding: 12px 16px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown a {
            text-decoration: none;
            color: #0366d6;
            padding: 8px 0;
            display: block;
        }

        .dropdown a.active {
            font-weight: bold;
            background-color: #eaf5ff;
        }

        /* Sidebar navigation for TOC */
        .toc-sidebar {
            width: 250px;
            position: fixed;
            top: 60px;
            bottom: 0;
            left: 0;
            background-color: #fff;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #eaecef;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
            z-index: 999;
        }

        .toc-sidebar.open {
            transform: translateY(0);
        }

        .toc-link::before {
            display: none;
        }

        .toc-sidebar ul {
            list-style: none;
            padding-left: 0;
            line-height: 1.0;
            font-size: 15px;
        }

        .toc-sidebar li {
            margin-left: 0;
            padding-left: 0;
        }

        .js-toc > a {
            font-weight: bold;
            font-size: 18px;

        }

        .js-toc > ul > li {
            margin-top: 25px;
        }

        .js-toc > ul > li > a {
            font-weight: bold;
        }

        .js-toc > ul > li > ul > li > ul > li {
            padding-left: 10px;
        }

        .toc-sidebar a {
            word-wrap: break-word;
            display: block;
            padding: 1px 10px;
            margin-bottom: 5px;
            text-decoration: none;
            color: #0366d6;
            border-radius: 6px;
        }

        .toc-sidebar a:hover {
            background-color: #f1f8ff;
            text-decoration: none;
        }

        .toc-sidebar .is-active-link {
            background-color: #eaf5ff;
            color: #0366d6;
            border-radius: 6px;
        }

        /* Main content area */
        main {
            margin-left: 300px;
            padding: 20px;
            flex-grow: 1;
            max-width: 900px;
        }

        main h1 {
            display: none;
        }

        main h2 {
            font-size: 28px;
            margin-bottom: 16px;
        }

        main h3 {
            font-size: 24px;
            margin-bottom: 12px;
        }

        main h4 {
            font-size: 20px;
            margin-bottom: 12px;
        }

        main p {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .is-active-link {
            font-weight: normal;
        }

        .scroll-spacer {
            height: 300px;
        }

        /* Footer */
        footer {
            margin-left: 300px;
            color: #0366d6;
            background-color: #f9fafb;
            padding: 40px 20px;
            font-size: 14px;
            max-width: 900px;
        }

        footer h3 {
            color: #0366d6;
        }

        footer ul {
            list-style: none;
            padding: 0;
        }

        footer ul li a {
            color: #0366d6;
            text-decoration: none;
        }

        footer ul li a:hover {
            text-decoration: underline;
        }

        footer .social-icons a img {
            width: 20px;
            margin-right: 10px;
        }

        .footer-container {
            display: flex;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .footer-column {
            flex: 1;
            max-width: 300px; /* Set a max-width for each column */
            padding: 0 20px;  /* Add padding for some space between the columns */
        }

        /* Mobile Styles */
        .hamburger {
            display: none;
            cursor: pointer;
            flex-direction: column;
            justify-content: space-between;
            width: 24px;
            height: 18px;
        }

        .bar {
            height: 3px;
            width: 100%;
            background-color: #0366d6;
            border-radius: 10px;
        }

        @media (max-width: 768px) {

            .hamburger {
                display: flex;
                margin-right: 20px;
            }

            .toc-sidebar {
                transform: translateY(-100%);
                width: 100%;
            }

            main {
                margin-left: 0;
                padding: 20px;
                max-width: 100%;
            }

            footer {
                display: none;
            }
        }

        /* Modal background */
        #search-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* Modal content */
        #modal-content {
            top: 20%;
            background: white;
            padding: 20px;
            width: 60%;
            max-width: 600px;
            position: relative;
            border-radius: 6px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        /* Search input with magnifying glass */
        .search-icon-wrapper {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px;
            border: 1px solid #eaecef;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .search-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        /* Updated input style */
        #search-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 20px;
        }

        /* Search results */
        #search-results {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid #eaecef;
            padding-top: 10px;
            outline: none; /* Disable the strong outline */
        }

        .search-result {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaecef;
        }

        .search-result-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #0366d6;
            text-decoration: none;
        }

        .search-result-title:hover {
            text-decoration: underline;
        }

        .search-result-context {
            font-size: 14px;
            color: #586069;
        }

        /* Highlighted search result */
        .highlight {
            background-color: #eaecef;
        }

        /* Softer focus style for search results */
        #search-results:focus {
            border: 2px solid #ddd; /* Softer border on focus */
            outline: none;
        }

        /* Soft yellow highlight for selected section */
        .highlight-section {
            background-color: #fffbcc;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header class="header">
        <div class="logo">
            <div class="hamburger" id="hamburger">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>

            <a href="/">Expensify</a>
            /
            <!-- Dropdown for product selection -->
            <div class="dropdown">
                <span>{{ page.title | remove_first: 'Expensify ' }}</span>
                <div class="dropdown-content">
                    <a href="/expense" class="{% if page.title == 'Expensify Expense' %}active{% endif %}">Expense</a>
                    <a href="/card" class="{% if page.title == 'Expensify Cards' %}active{% endif %}">Card</a>
                    <a href="/travel" class="{% if page.title == 'Expensify Travel' %}active{% endif %}">Travel</a>
                    <a href="/chat" class="{% if page.title == 'Expensify Chat' %}active{% endif %}">Chat</a>
                    <a href="/invoice" class="{% if page.title == 'Expensify Invoice' %}active{% endif %}">Invoice</a>
                    <a href="/billpay" class="{% if page.title == 'Expensify Billpay' %}active{% endif %}">Billpay</a>
                </div>
            </div>
        </div>
        <div id="search-container">
            <!-- Search Input styled as button -->
            <span id="search-icon" style="cursor: pointer; font-size: 24px;">🔍</span>

            <!-- Search Modal -->
            <div id="search-modal" style="display:none;">
                <div id="modal-content">
                    <div class="search-icon-wrapper">
                        <span class="search-icon">🔍</span>
                        <input type="text" id="search-input" placeholder="Go to..." />
                    </div>
                    <!-- Hidden Search Button -->
                    <button id="search-submit" style="display:none;">Search</button>

                    <!-- Search results container with tabindex to make it focusable -->
                    <div id="search-results" tabindex="0" style="display:none;"></div>

                    <!-- Footer with shortcut info -->
                    <div id="search-footer" style="text-align: center; margin-top: 10px; font-size: 14px; color: #586069;">
                        ⇵ Select, ↩ Go
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- TOC Sidebar -->
    <nav class="toc-sidebar" id="toc-sidebar">
        <div class="js-toc"></div>
    </nav>

    <!-- Main Content -->
    <h1>{{ page.title }}</h1>
    <main class="js-toc-content">
        {{ content }}

        <!-- Spacer div for scrolling -->
        <div class="scroll-spacer"></div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h3>Features</h3>
                <ul>
                    <li><a href="https://use.expensify.com/expense-management">Expense Management</a></li>
                    <li><a href="https://use.expensify.com/spend-management">Spend Management</a></li>
                    <li><a href="https://use.expensify.com/expense-reports">Expense Reports</a></li>
                    <li><a href="https://use.expensify.com/company-credit-card">Company Card</a></li>
                    <li><a href="https://use.expensify.com/receipt-scanning-app">Receipt Scanning App</a></li>
                    <li><a href="https://use.expensify.com/payments">Payments</a></li>
                    <li><a href="https://use.expensify.com/bill-pay-app">Bill Pay</a></li>
                    <li><a href="https://use.expensify.com/invoicing-software">Invoicing</a></li>
                    <li><a href="https://use.expensify.com/travel">Travel</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Resources</h3>
                <ul>
                    <li><a href="https://use.expensify.com/accountants">ExpensifyApproved!</a></li>
                    <li><a href="https://use.expensify.com/press-kit">Press Kit</a></li>
                    <li><a href="https://use.expensify.com/support">Support</a></li>
                    <li><a href="https://help.expensify.com/">ExpensifyHelp</a></li>
                    <li><a href="https://www.expensify.com/terms">Terms of Service</a></li>
                    <li><a href="https://www.expensify.com/privacy">Privacy</a></li>
                    <li><a href="https://use.expensify.com/download">Expensify App</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Learn more</h3>
                <ul>
                    <li><a href="https://we.are.expensify.com/how-we-got-here">About Expensify</a></li>
                    <li><a href="https://use.expensify.com/blog">Blog</a></li>
                    <li><a href="https://we.are.expensify.com/">Jobs</a></li>
                    <li><a href="https://www.expensify.org">Expensify.org</a></li>
                    <li><a href="https://ir.expensify.com">Investor Relations</a></li>
                </ul>
                <div class="social-icons">
                    <a href="https://www.twitter.com/expensify" title="Twitter">
                        <img src="https://img.icons8.com/material-outlined/24/000000/twitter.png" alt="Twitter">
                    </a>
                    <a href="http://www.instagram.com/expensify" title="Instagram">
                        <img src="https://img.icons8.com/material-outlined/24/000000/instagram-new.png" alt="Instagram">
                    </a>
                    <a href="https://www.facebook.com/expensify" title="Facebook">
                        <img src="https://img.icons8.com/material-outlined/24/000000/facebook.png" alt="Facebook">
                    </a>
                    <a href="http://www.linkedin.com/company/expensify" title="LinkedIn">
                        <img src="https://img.icons8.com/material-outlined/24/000000/linkedin.png" alt="LinkedIn">
                    </a>
                </div>
            </div>

            <div class="footer-column">
                <h3>Get Started</h3>
                <ul>
                    <li><a href="https://www.expensify.com">Create a new account</a></li>
                    <li><a href="https://www.expensify.com">Log in</a></li>
                    <li>
                        <a href="https://apps.apple.com/us/app/expensify-receipts-expenses/id471713959">
                            <img src="https://developer.apple.com/app-store/marketing/guidelines/images/badge-example-preferred_2x.png" width="100" alt="iOS App">
                        </a>
                    </li>
                    <li>
                        <a href="https://play.google.com/store/apps/details?id=org.me.mobiexpensifyg">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Google_Play_Store_badge_EN.svg" width="100" alt="Android App">
                        </a>
                    </li>
                </ul>
                <p>©2008-2024 Expensify, Inc.</p>
            </div>

            </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.32.1/tocbot.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>
    <script>
        function updateURLHashOnScroll() {
            const activeLink = document.querySelector('.toc-sidebar .is-active-link');
            if (activeLink) {
                const hash = activeLink.getAttribute('href');
                if (history.pushState) {
                    history.pushState(null, null, hash);
                } else {
                    window.location.hash = hash;
                }
            }
        }

        function scrollActiveLinkIntoView() {
            const activeLink = document.querySelector('.toc-sidebar .is-active-link');
            if (activeLink) {
                activeLink.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });
            }
        }

        tocbot.init({
          tocSelector: '.js-toc',
          contentSelector: '.js-toc-content',
          headingSelector: 'h1, h2, h3, h4, h5, h6',
          collapseDepth: 4,
          orderedList: false,
          scrollSmooth: true,
          scrollToActive: true,
          enableUrlHashUpdateOnScroll: false,
          headingsOffset: 80,
          scrollSmoothOffset: -80,
          tocScrollingWrapper: document.querySelector('.toc-sidebar'),
          tocScrollOffset: 80,
          headingObjectCallback: function(obj, element) {
            const tocTitle = element.getAttribute('data-toc-title');
            if (tocTitle) {
                obj.textContent = tocTitle;
            }
            return obj;
          },
          onClick: function(e) {
              setTimeout(scrollActiveLinkIntoView, 300);
              document.getElementById('toc-sidebar').classList.remove('open'); // Close TOC after clicking
          },
          scrollEndCallback: function() {
              updateURLHashOnScroll();
              scrollActiveLinkIntoView();
          }
        });

        function adjustAnchorOnLoad() {
            if (window.location.hash) {
                const element = document.querySelector(window.location.hash);
                if (element) {
                    window.scrollTo({
                        top: element.getBoundingClientRect().top + window.pageYOffset - 80,
                        behavior: 'smooth'
                    });
                }
            }
        }

        window.addEventListener('load', adjustAnchorOnLoad);

        // Toggle sidebar on hamburger click
        document.getElementById('hamburger').addEventListener('click', function() {
            var sidebar = document.getElementById('toc-sidebar');
            sidebar.classList.toggle('open');
        });

        // Keep track of the search results
        let g_searchResultsArray = [];
        let g_currentSelectionIndex = -1;
        let g_highlightedSection = null;

        // Declare the index variable globally so it can be reused
        let g_index = null;

        // Look up some commonly used elements once
        const g_searchIcon = document.getElementById('search-icon');
        const g_searchModal = document.getElementById('search-modal');
        const g_searchResults = document.getElementById('search-results');
        const g_searchInput = document.getElementById('search-input');

        // Show and initialize the search modal
        function showSearchModal() {
            g_searchModal.style.display = 'flex';
            if (g_searchResultsArray.length > 0) {
                g_searchResults.style.display = 'block';
                g_searchResults.focus(); // Focus on search results if they exist
            } else {
                g_searchInput.focus();
            }
        }

        // Open modal when search icon is clicked
        g_searchIcon.addEventListener('click', showSearchModal);

        // Open modal when Cmd+K is pressed
        document.addEventListener('keydown', function(event) {
            if (event.metaKey && event.key === 'k') {
                event.preventDefault();
                showSearchModal();
            }
        });

        // Close modal when pressing "Escape"
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && g_searchModal.style.display === 'flex') {
                g_searchModal.style.display = 'none';
            }
        });

        // Close modal when clicking outside of modal content
        window.addEventListener('click', function(event) {
            if (event.target == g_searchModal) {
                g_searchModal.style.display = 'none';
            }
        });

        // Handle keyboard navigation (arrow keys and enter)
        g_searchResults.addEventListener('keydown', function(event) {
            // If the modal is being shown and has active search results, capture keydown
            if (g_searchModal.style.display === 'flex' && g_searchResultsArray.length > 0) {
                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    selectNextResult();
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    selectPreviousResult();
                } else if (event.key === 'Enter' && g_currentSelectionIndex >= 0) {
                    event.preventDefault();
                    navigateToSelectedResult();
                } else if (!['Tab', 'Shift'].includes(event.key)) {
                    g_searchInput.focus(); // Focus back on input if typing occurs
                }
            }
        });

        function selectNextResult() {
            if (g_currentSelectionIndex < g_searchResultsArray.length - 1) {
                g_currentSelectionIndex++;
                updateSelectedResult();
            }
        }

        function selectPreviousResult() {
            if (g_currentSelectionIndex > 0) {
                g_currentSelectionIndex--;
                updateSelectedResult();
            }
        }

        function updateSelectedResult() {
            g_searchResultsArray.forEach((result, index) => {
                if (index === g_currentSelectionIndex) {
                    result.classList.add('highlight');
                    result.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                } else {
                    result.classList.remove('highlight');
                }
            });
        }

        function navigateToSelectedResult() {
            const selectedResult = g_searchResultsArray[g_currentSelectionIndex];
            const link = selectedResult.querySelector('a');
            if (link) {
                link.click();
            }
        }

        // Execute search when pressing "Enter" in the input field
        g_searchInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                g_searchSubmit.click();
            }
        });

        // Perform search when search button is clicked
        const g_searchSubmit = document.getElementById('search-submit');

        // Handle submitting the search query
        g_searchSubmit.addEventListener('click', async function() {
            const query = g_searchInput.value.trim().toLowerCase();
            g_searchResults.innerHTML = '';
            g_currentSelectionIndex = -1;

            if (query.length === 0) {
                g_searchResults.style.display = 'none';
                return;
            }

            // Load the JSON search index file, if not already defined
            if (g_index === null) {
                console.log('Loading search index from:', '/searchIndex.json');
                const response = await fetch('/searchIndex.json');
                const indexData = await response.json();
                g_index = new FlexSearch.Document({
                    document: {
                        id: 'id',
                        index: ['content'], // Index on the content field
                        store: ['title', 'url', 'content'], // Store title, URL, and content
                    }
                });

                // Import the index
                for (const [key, data] of Object.entries(indexData)) {
                    await g_index.import(key, data);
                }
            } else {
                console.log('Reusing existing search index');
            }

            // Perform search
            const results = await g_index.search({
                query,
                field: 'content'
            });

            if (results.length > 0) {
                g_searchResultsArray = [];
                results.forEach(result => {
                    result.result.forEach(docId => {
                        const doc = g_index.store[docId];
                        if (doc && doc.content) {
                            const searchTermIndex = doc.content.toLowerCase().indexOf(query);
                            const contextBefore = doc.content.substring(Math.max(0, searchTermIndex - 30), searchTermIndex);
                            const contextAfter = doc.content.substring(searchTermIndex + query.length, Math.min(doc.content.length, searchTermIndex + query.length + 30));
                            const searchResultHtml = `
                              <div class="search-result">
                                <a href="${doc.url}" class="search-result-title" onclick="scrollToTOC('${doc.url}')">${doc.title}</a>
                                <div class="search-result-context">...${contextBefore}<strong>${query}</strong>${contextAfter}...</div>
                              </div>
                            `;
                            const resultElement = document.createElement('div');
                            resultElement.innerHTML = searchResultHtml;
                            g_searchResults.appendChild(resultElement);
                            g_searchResultsArray.push(resultElement);

                            // Automatically select the first result
                            if (g_searchResultsArray.length === 1) {
                                g_currentSelectionIndex = 0;
                                updateSelectedResult();
                            }
                        }
                    });
                });
                g_searchResults.style.display = 'block';
                g_searchResults.focus();  // Focus on search results whenever there are results
            } else {
                g_searchResults.style.display = 'none';
            }
        });

        // Trigger the TOC link click to use TocBot's smooth scrolling behavior
        function scrollToTOC(url) {
            const elementId = url.split('#')[1];
            const tocLink = document.querySelector(`.toc-sidebar a[href="#${elementId}"]`);

            if (tocLink) {
                tocLink.click(); // Simulate a click on the TOC link for smooth scroll
                highlightSelectedSection(elementId); // Highlight the section in yellow
                closeModalAfterClick();
            }
        }

        // Highlight the selected section
        function highlightSelectedSection(sectionId) {
            // Remove the previous highlight, if any
            if (g_highlightedSection) {
                g_highlightedSection.classList.remove('highlight-section');
            }

            // Highlight the new section
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                sectionElement.classList.add('highlight-section');
                g_highlightedSection = sectionElement;
            }
        }

        // Close modal after clicking a search result
        function closeModalAfterClick() {
            g_searchModal.style.display = 'none';
        }
    </script>

</body>
</html>